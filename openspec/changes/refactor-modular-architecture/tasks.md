# 实现任务清单

## 1. 准备工作
- [ ] 1.1 创建新分支 `refactor/modular-architecture`
- [ ] 1.2 创建新的目录结构（`config/`、`migration/`、`provider/`、`cli/`）

## 2. 实现 config 包
- [ ] 2.1 定义 `Env`、`ProviderConfig`、`Settings`、`Config` 类型
- [ ] 2.2 实现 `Load()` 函数，从文件加载配置
- [ ] 2.3 实现 `Save()` 函数，保存配置到文件
- [ ] 2.4 实现配置路径获取函数
- [ ] 2.5 添加 `config_test.go`，测试加载、保存、边界情况

## 3. 实现 provider 包
- [ ] 3.1 实现 `Switch()` 函数，处理提供商切换
- [ ] 3.2 实现 `Merge()` 函数，深度合并配置
- [ ] 3.3 实现 `GetAuthToken()` 函数，提取认证令牌
- [ ] 3.4 添加 `provider_test.go`，测试切换、合并、令牌提取

## 4. 实现 migration 包
- [ ] 4.1 实现 `CheckExisting()` 函数，检测旧配置
- [ ] 4.2 实现 `PromptUser()` 函数，提示用户确认
- [ ] 4.3 实现 `MigrateFromSettings()` 函数，执行迁移
- [ ] 4.4 添加 `migration_test.go`，迁移所有现有测试

## 5. 实现 cli 包
- [ ] 5.1 定义 `Command` 结构体
- [ ] 5.2 实现 `Parse()` 函数，解析命令行参数
- [ ] 5.3 实现 `Run()` 函数，执行命令
- [ ] 5.4 实现 `ShowHelp()` 函数，显示帮助信息
- [ ] 5.5 实现 `ShowVersion()` 函数，显示版本信息
- [ ] 5.6 添加 `cli_test.go`，测试命令解析

## 6. 重构 main.go
- [ ] 6.1 简化 main.go，调用新的包接口
- [ ] 6.2 移除已迁移的代码
- [ ] 6.3 保持 CLI 接口兼容
- [ ] 6.4 验证所有功能正常工作

## 7. 测试增强
- [ ] 7.1 添加集成测试 `integration_test.go`
- [ ] 7.2 添加测试覆盖率验证（目标 ≥80%）
- [ ] 7.3 运行竞态检测 `go test -race`
- [ ] 7.4 确保 CI 通过

## 8. 文档和提交
- [ ] 8.1 更新 README.md（如需要）
- [ ] 8.2 分阶段提交，每个包一个 commit
- [ ] 8.3 创建 PR 并描述变更

## 依赖关系
- 任务 2（config）必须首先完成，其他包依赖它
- 任务 3、4、5 可以并行开发
- 任务 6 必须等待 2、3、4、5 完成
- 任务 7 最后执行

## 可并行化
- 任务 3、4、5 可以并行开发（各自独立包）
- 测试文件可以与实现同步编写
