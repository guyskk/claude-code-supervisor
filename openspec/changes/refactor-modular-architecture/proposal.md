# 变更: 重构项目架构以提升可维护性、可测试性和可扩展性

## 背景

当前项目采用单文件架构（main.go 467 行），所有代码都在一个 package 中。虽然这符合简单性原则，但随着项目发展，已出现以下问题：

1. **可维护性问题**：配置管理、命令行解析、迁移逻辑、子进程执行等多个职责混在一起
2. **类型安全问题**：使用 `map[string]interface{}` 处理配置，缺乏编译时类型检查
3. **可测试性不足**：核心函数如 `switchProvider`、`runClaude` 无法测试（与 main 耦合）
4. **可扩展性受限**：添加新功能需要修改 main.go，缺乏清晰的模块边界

## 变更内容

### 架构重组
- 将单文件拆分为多个独立的内部包（`config`、`cli`、`provider`、`migration`）
- 每个包有单一职责和清晰的公共接口
- 保持单二进制分发的目标不变

### 类型安全配置
- 定义强类型的配置结构体替代 `map[string]interface{}`
- 添加 JSON 序列化/反序列化的验证和错误处理
- 支持配置的深度合并和验证

### 测试覆盖增强
- 为所有核心功能添加单元测试
- 添加集成测试覆盖完整流程
- 引入测试辅助工具和 mock

### 错误处理改进
- 统一的错误类型和错误包装
- 更清晰的错误上下文信息
- 友好的用户提示

## 影响范围

### 影响的规范
- `config-migration` - 迁移逻辑将移到独立包
- 新增 `core-config` 规范 - 核心配置管理
- 新增 `cli` 规范 - 命令行接口
- 新增 `provider-management` 规范 - 提供商切换
- 新增 `testing` 规范 - 测试标准

### 影响的代码
- `main.go` - 重构为多个文件
- `main_test.go` - 扩展测试覆盖
- 无破坏性变更 - 用户接口保持兼容

## 兼容性

- **用户接口**：CLI 命令和配置文件格式完全兼容
- **行为**：所有现有功能保持相同行为
- **迁移**：用户无需任何操作
