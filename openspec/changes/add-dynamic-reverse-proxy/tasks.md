# Tasks: add-dynamic-reverse-proxy

## 1. 核心代理实现

### 1.1 创建 proxy 包
- [ ] 1.1.1 创建 `internal/proxy/` 目录
- [ ] 1.1.2 实现 `ProxyServer` 结构体
- [ ] 1.1.3 实现基本的 HTTP 服务器
- [ ] 1.1.4 实现 `httputil.ReverseProxy` 封装
- [ ] 1.1.5 添加单位测试

### 1.2 实现提供商切换
- [ ] 1.2.1 实现 `ProviderRegistry` 存储提供商配置
- [ ] 1.2.2 实现原子性的当前提供商状态管理
- [ ] 1.2.3 实现动态目标切换逻辑
- [ ] 1.2.4 添加提供商验证功能
- [ ] 1.2.5 添加单位测试

### 1.3 实现 API Key 转发
- [ ] 1.3.1 从配置中提取提供商 API Key
- [ ] 1.3.2 转发请求时添加 Authorization 头
- [ ] 1.3.3 确保不泄露 API Key 到日志
- [ ] 1.3.4 添加单位测试

## 2. 管理 API 实现

### 2.1 基础 API 路由
- [ ] 2.1.1 实现 `GET /api/providers` 获取提供商列表
- [ ] 2.1.2 实现 `GET /api/provider/current` 获取当前提供商
- [ ] 2.1.3 实现 `PUT /api/provider/current` 切换提供商
- [ ] 2.1.4 实现 `GET /api/health` 健康检查
- [ ] 2.1.5 添加 API 单位测试

### 2.2 请求验证
- [ ] 2.2.1 实现 JSON 请求体验证
- [ ] 2.2.2 实现提供商存在性检查
- [ ] 2.2.3 实现错误响应格式化
- [ ] 2.2.4 添加 API 验证测试

## 3. 配置集成

### 3.1 Proxy 配置结构
- [ ] 3.1.1 在 `Config` 中添加 `Proxy` 字段
- [ ] 3.1.2 实现 `ProxyConfig` 结构体
- [ ] 3.1.3 实现配置加载和验证
- [ ] 3.1.4 添加配置测试

### 3.2 Settings.json 修改
- [ ] 3.2.1 实现自动修改 ANTHROPIC_BASE_URL 指向代理
- [ ] 3.2.2 保留原始提供商信息
- [ ] 3.2.3 确保代理端口正确写入
- [ ] 3.2.4 添加集成测试

## 4. CLI 集成

### 4.1 代理启动逻辑
- [ ] 4.1.1 检测 proxy.enabled 配置
- [ ] 4.1.2 在后台启动代理服务器
- [ ] 4.1.3 等待代理就绪后启动 Claude
- [ ] 4.1.4 处理代理启动失败

### 4.2 端口管理
- [ ] 4.2.1 支持配置监听地址
- [ ] 4.2.2 实现端口占用检测
- [ ] 4.2.3 实现自动选择可用端口
- [ ] 4.2.4 输出代理地址到 stderr

## 5. 文档和测试

### 5.1 文档
- [ ] 5.1.1 更新 README.md 添加代理功能说明
- [ ] 5.1.2 添加配置示例
- [ ] 5.1.3 添加 API 使用说明
- [ ] 5.1.4 更新 README-CN.md

### 5.2 集成测试
- [ ] 5.2.1 测试代理启动和停止
- [ ] 5.2.2 测试提供商切换
- [ ] 5.2.3 测试 API 请求转发
- [ ] 5.2.4 测试错误处理

### 5.3 E2E 测试
- [ ] 5.3.1 测试完整工作流程
- [ ] 5.3.2 测试 Claude Code 集成
- [ ] 5.3.3 测试并发请求处理

## 依赖关系

- 任务 1 必须在任务 2 之前完成
- 任务 3 可以与任务 1 并行开发
- 任务 4 需要任务 1 和 3 完成
- 任务 5 在所有实现任务完成后进行

## 并行化机会

- 1.1、1.2、1.3 可以并行开发
- 2.1、3.1 可以并行开发
- 5.1 文档可以提前编写
